#################################
#
# Re-gridding Script
#
# Adrienne Wootten 8/19/2015
#
#################################
#
# NOTE: File will auto regrid for all timeslices available
#
####################################

#/data/osu/prism/daily/combo

#args <- commandArgs(trailingOnly = TRUE)

#args = c("wicci","prcp","twentyc3m")

#dataset = args[1]
#var = args[2]
#period = args[3]

#files = system(paste("ls /data/osu/prism/daily/combo/",period,"*",var,"*.nc",sep=""),intern=TRUE)

datasetname = "wicci"
variable = "tmin"

#files = c(
#system(paste("ls ",datasetname,"/SE/sresa2-*",variable,"-01.nc",sep=""),intern=TRUE),
#system(paste("ls ",datasetname,"/SE/sresa1b-*",variable,"-01.nc",sep=""),intern=TRUE),
#system(paste("ls ",datasetname,"/SE/sresb1-*",variable,"-01.nc",sep=""),intern=TRUE)
#)

files = system(paste("ls ",datasetname,"/SE/twentyc3m-*",variable,"-01.nc",sep=""),intern=TRUE)

#files
#####################

library(ncdf)
library(sp)
library(fields)

newlat=c(25.13511, 25.27025, 25.40538, 25.54052, 25.67565, 25.81079, 25.94592, 26.08106, 26.21619, 26.35133, 26.48646, 26.62160, 26.75673, 26.89187, 27.02700, 27.16214, 27.29727, 27.43241, 27.56754, 27.70268, 27.83781, 27.97295, 28.10808, 28.24322, 28.37835, 28.51349, 28.64862, 28.78376, 28.91889, 29.05403, 29.18916, 29.32430, 29.45943, 29.59457, 29.72970, 29.86484, 29.99997, 30.13511, 30.27024, 30.40538, 30.54051, 30.67565, 30.81078, 30.94592, 31.08105, 31.21619, 31.35132, 31.48646, 31.62159, 31.75673, 31.89186, 32.02700, 32.16213, 32.29727, 32.43240, 32.56754, 32.70267, 32.83781, 32.97294, 33.10808, 33.24321, 33.37835, 33.51348, 33.64862, 33.78375, 33.91889, 34.05402, 34.18916, 34.32429, 34.45943, 34.59456, 34.72970, 34.86483, 34.99997, 35.13510, 35.27024, 35.40537, 35.54051, 35.67564, 35.81078, 35.94591, 36.08105, 36.21618, 36.35132, 36.48645, 36.62159, 36.75672, 36.89186, 37.02699, 37.16213, 37.29726, 37.43240, 37.56753, 37.70267, 37.83780, 37.97294, 38.10807, 38.24321, 38.37834, 38.51348, 38.64861, 38.78375, 38.91888, 39.05402, 39.18915, 39.32429, 39.45942, 39.59456, 39.72969, 39.86483, 39.99996, 40.13510, 40.27023)

newlon=c(-102.97288, -102.83774, -102.70261, -102.56747, -102.43234, -102.29720, -102.16207, -102.02693, -101.89180, -101.75666, -101.62153, -101.48639, -101.35126, -101.21612, -101.08099, -100.94585, -100.81072, -100.67558, -100.54045, -100.40531, -100.27018, -100.13504,  -99.99991,  -99.86477, -99.72964, -99.59450, -99.45937, -99.32423, -99.18910, -99.05396, -98.91883, -98.78369, -98.64856, -98.51342, -98.37829, -98.24315, -98.10802, -97.97288, -97.83775, -97.70261, -97.56748, -97.43234, -97.29721, -97.16207, -97.02694, -96.89180, -96.75667, -96.62153, -96.48640, -96.35126, -96.21613, -96.08099, -95.94586, -95.81072, -95.67559, -95.54045, -95.40532, -95.27018, -95.13505, -94.99991, -94.86478, -94.72964, -94.59451, -94.45937, -94.32424, -94.18910, -94.05397, -93.91883, -93.78370, -93.64856, -93.51343, -93.37829, -93.24316, -93.10802, -92.97289, -92.83775, -92.70262, -92.56748, -92.43235, -92.29721, -92.16208, -92.02694, -91.89181, -91.75667, -91.62154, -91.48640, -91.35127, -91.21613, -91.08100, -90.94586, -90.81073, -90.67559, -90.54046, -90.40532, -90.27019, -90.13505, -89.99992, -89.86478, -89.72965, -89.59451, -89.45938, -89.32424, -89.18911, -89.05397, -88.91884, -88.78370, -88.64857, -88.51343, -88.37830, -88.24316, -88.10803, -87.97289, -87.83776, -87.70262, -87.56749, -87.43235, -87.29722, -87.16208, -87.02695, -86.89181, -86.75668, -86.62154, -86.48641, -86.35127, -86.21614, -86.08100, -85.94587, -85.81073, -85.67560, -85.54046, -85.40533, -85.27019, -85.13506, -84.99992, -84.86479, -84.72965, -84.59452, -84.45938, -84.32425, -84.18911, -84.05398, -83.91884, -83.78371, -83.64857, -83.51344, -83.37830, -83.24317, -83.10803, -82.97290, -82.83776, -82.70263, -82.56749, -82.43236, -82.29722, -82.16209, -82.02695, -81.89182, -81.75668, -81.62155, -81.48641, -81.35128, -81.21614, -81.08101, -80.94587, -80.81074, -80.67560, -80.54047, -80.40533, -80.27020, -80.13506, -79.99993, -79.86479, -79.72966, -79.59452, -79.45939, -79.32425, -79.18912, -79.05398, -78.91885, -78.78371, -78.64858, -78.51344, -78.37831, -78.24317, -78.10804, -77.97290, -77.83777, -77.70263, -77.56750, -77.43236, -77.29723, -77.16209, -77.02696, -76.89182, -76.75669, -76.62155, -76.48642, -76.35128, -76.21615, -76.08101, -75.94588, -75.81074, -75.67561, -75.54047, -75.40534, -75.27020, -75.13507, -74.99993, -74.86480, -74.72966, -74.59453, -74.45939, -74.32426, -74.18912, -74.05399)

#newlat=c(33.51348, 33.64862, 33.78375, 33.91889, 34.05402, 34.18916, 34.32429, 34.45943, 34.59456, 34.72970, 34.86483, 34.99997, 35.13510, 35.27024, 35.40537, 35.54051, 35.67564, 35.81078, 35.94591, 36.08105, 36.21618, 36.35132, 36.48645, 36.62159)
#newlon = c(-79.99993, -79.86479, -79.72966, -79.59452, -79.45939, -79.32425, -79.18912, -79.05398, -78.91885, -78.78371, -78.64858, -78.51344, -78.37831, -78.24317, -78.10804, -77.97290, -77.83777, -77.70263, -77.56750, -77.43236, -77.29723, -77.16209, -77.02696, -76.89182, -76.75669, -76.62155, -76.48642, -76.35128, -76.21615, -76.08101, -75.94588, -75.81074, -75.67561, -75.54047, -75.40534, -75.27020, -75.13507)

newrownum = length(newlon) # number of cells in x direction
newcolnum = length(newlat)  # number of cells in y direction

#times = 1:length(files)-1

# Go through all the files to do regridding for each time

for(f in 1:length(files)){
ptm1 = proc.time()

message("File regrid began at ",Sys.time()," for file: ",files[f])

# read file
test = open.ncdf(files[f])

lonname = test$var[[1]]$dim[[1]]$name
latname = test$var[[1]]$dim[[2]]$name
timename = test$var[[1]]$dim[[3]]$name

lon = get.var.ncdf(test,lonname)
lat = get.var.ncdf(test,latname)
time = get.var.ncdf(test,timename)

if(all(lon==0)==TRUE){
lon=c( -103, -102.9, -102.8, -102.7, -102.6, -102.5, -102.4, -102.3, -102.2,
    -102.1, -102, -101.9, -101.8, -101.7, -101.6, -101.5, -101.4, -101.3,
    -101.2, -101.1, -101, -100.9, -100.8, -100.7, -100.6, -100.5, -100.4,
    -100.3, -100.2, -100.1, -100, -99.9, -99.8, -99.7, -99.6, -99.5, -99.4,
    -99.3, -99.2, -99.1, -99, -98.9, -98.8, -98.7, -98.6, -98.5, -98.4,
    -98.3, -98.2, -98.1, -98, -97.9, -97.8, -97.7, -97.6, -97.5, -97.4,
    -97.3, -97.2, -97.1, -97, -96.9, -96.8, -96.7, -96.6, -96.5, -96.4,
    -96.3, -96.2, -96.1, -96, -95.9, -95.8, -95.7, -95.6, -95.5, -95.4,
    -95.3, -95.2, -95.1, -95, -94.9, -94.8, -94.7, -94.6, -94.5, -94.4,
    -94.3, -94.2, -94.1, -94, -93.9, -93.8, -93.7, -93.6, -93.5, -93.4,
    -93.3, -93.2, -93.1, -93, -92.9, -92.8, -92.7, -92.6, -92.5, -92.4,
    -92.3, -92.2, -92.1, -92, -91.9, -91.8, -91.7, -91.6, -91.5, -91.4,
    -91.3, -91.2, -91.1, -91, -90.9, -90.8, -90.7, -90.6, -90.5, -90.4,
    -90.3, -90.2, -90.1, -90, -89.9, -89.8, -89.7, -89.6, -89.5, -89.4,
    -89.3, -89.2, -89.1, -89, -88.9, -88.8, -88.7, -88.6, -88.5, -88.4,
    -88.3, -88.2, -88.1, -88, -87.9, -87.8, -87.7, -87.6, -87.5, -87.4,
    -87.3, -87.2, -87.1, -87, -86.9, -86.8, -86.7, -86.6, -86.5, -86.4,
    -86.3, -86.2, -86.1, -86, -85.9, -85.8, -85.7, -85.6, -85.5, -85.4,
    -85.3, -85.2, -85.1, -85, -84.9, -84.8, -84.7, -84.6, -84.5, -84.4,
    -84.3, -84.2, -84.1, -84, -83.9, -83.8, -83.7, -83.6, -83.5, -83.4,
    -83.3, -83.2, -83.1, -83, -82.9, -82.8, -82.7, -82.6, -82.5, -82.4,
    -82.3, -82.2, -82.1, -82, -81.9, -81.8, -81.7, -81.6, -81.5, -81.4,
    -81.3, -81.2, -81.1, -81, -80.9, -80.8, -80.7, -80.6, -80.5, -80.4,
    -80.3, -80.2, -80.1, -80, -79.9, -79.8, -79.7, -79.6, -79.5, -79.4,
    -79.3, -79.2, -79.1, -79, -78.9, -78.8, -78.7, -78.6, -78.5, -78.4,
    -78.3, -78.2, -78.1, -78, -77.9, -77.8, -77.7, -77.6, -77.5, -77.4,
    -77.3, -77.2, -77.1, -77, -76.9, -76.8, -76.7, -76.6, -76.5, -76.4,
    -76.3, -76.2, -76.1, -76, -75.9, -75.8, -75.7, -75.6, -75.5, -75.4,
    -75.3, -75.2, -75.1, -75, -74.9, -74.8, -74.7)
}

if(all(lat==0)==TRUE){
 lat=c(25, 25.1, 25.2, 25.3, 25.4, 25.5, 25.6, 25.7, 25.8, 25.9, 26, 26.1,
    26.2, 26.3, 26.4, 26.5, 26.6, 26.7, 26.8, 26.9, 27, 27.1, 27.2, 27.3,
    27.4, 27.5, 27.6, 27.7, 27.8, 27.9, 28, 28.1, 28.2, 28.3, 28.4, 28.5,
    28.6, 28.7, 28.8, 28.9, 29, 29.1, 29.2, 29.3, 29.4, 29.5, 29.6, 29.7,
    29.8, 29.9, 30, 30.1, 30.2, 30.3, 30.4, 30.5, 30.6, 30.7, 30.8, 30.9, 31,
    31.1, 31.2, 31.3, 31.4, 31.5, 31.6, 31.7, 31.8, 31.9, 32, 32.1, 32.2,
    32.3, 32.4, 32.5, 32.6, 32.7, 32.8, 32.9, 33, 33.1, 33.2, 33.3, 33.4,
    33.5, 33.6, 33.7, 33.8, 33.9, 34, 34.1, 34.2, 34.3, 34.4, 34.5, 34.6,
    34.7, 34.8, 34.9, 35, 35.1, 35.2, 35.3, 35.4, 35.5, 35.6, 35.7, 35.8,
    35.9, 36, 36.1, 36.2, 36.3, 36.4, 36.5, 36.6, 36.7, 36.8, 36.9, 37, 37.1,
    37.2, 37.3, 37.4, 37.5, 37.6, 37.7, 37.8, 37.9, 38, 38.1, 38.2, 38.3,
    38.4, 38.5, 38.6, 38.7, 38.8, 38.9, 39, 39.1, 39.2, 39.3, 39.4, 39.5,
    39.6, 39.7, 39.8, 39.9, 40, 40.1, 40.2, 40.3)
}

#varname = variable
varname = test$var[[1]]$name
vardata = get.var.ncdf(test,varname)

#timelength = length(test$var[[1]]$dim[[3]]$vals)
#times = get.var.ncdf(test,test$var[[1]]$dim[[3]]$name)

if(f==1){
timeunits = test$var[[1]]$dim[[3]]$units
spunits = test$var[[1]]$dim[[2]]$units
missingval = test$var[[1]]$missval
varunits = test$var[[1]]$units
}

close.ncdf(test)

newmatrix = array(data=NA,dim=c(newrownum,newcolnum,length(time)))

#lat2 = rev(lat)
#tmax2 = tmax[,ncol(tmax):1]
#tmin2 = tmax[,ncol(tmin):1]
#prcp2 = tmax[,ncol(prcp):1]

for(i in 1:length(time)){

#ptm = proc.time()

test2var = interp.surface.grid(list(x=lon,y=lat,z=vardata[,,i]),grid.list=list(x=newlon,y=newlat))
newvar = matrix(test2var[[3]],nrow=length(newlon),ncol=length(newlat))
newmatrix[,,i] = newvar

}


###########
# Write new netcdf for Regridded data

dimX <- dim.def.ncdf( "lon", "degrees_east", newlon)
dimY <- dim.def.ncdf( "lat", "degrees_north", newlat )

dimT <- dim.def.ncdf( "time",timeunits,time)
# Make varables of various dimensionality, for illustration purposes
mv <- missingval # missing value to use

var1d <- var.def.ncdf(varname, varunits, list(dimX,dimY,dimT), mv )

# Create the test file
# Write some data to the file
# close ncdf

filesplit = strsplit(files[f],"/")[[1]]
fileout = paste(filesplit[1],"/SE/res15km/",filesplit[3],sep="")

nc1 <- create.ncdf(fileout , var1d )
put.var.ncdf( nc1, var1d, newmatrix) # no start or count: write all values\
close.ncdf(nc1)

message("Finished regridding file ",f," / ",length(files))
ptm1end = proc.time()-ptm1
message("Time = ",ptm1end[3]," secs")
message("File regrid complete at ",Sys.time())

}



